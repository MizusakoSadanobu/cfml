# Chapter 2: ランキングにおけるオフ方策評価
## 定式化

### 記号の定義
- X: ユーザの特徴量ベクトル (例: 年齢、性別、職業など)
- A: アイテムの集合 (例: 商品、ニュース記事など)
- a: 特定のアイテム
- π: ランキング (アイテムの並び順)
- Π(A): 全ての可能なランキングの集合
- a(k): ランキングπにおいてk番目の位置にあるアイテム
- r: 報酬ベクトル (各アイテムに対する報酬)
- rk: ランキングπにおいてk番目の位置にあるアイテムに対する報酬
- K: アイテムの総数
- |A|: アイテム集合Aの要素数 (Kと等しい)

### ランキング問題
- ランキング方策: ユーザごとに、どのランキングを提示するのかを決めるルールを**ランキング方策**と呼ぶ
- ランキング方策の例
    - 確率的な選択: ユーザごとに、複数のランキングをそれぞれある確率で提示するような方策。例えば、ユーザ1に対しては、ランキング1を20%、ランキング2を50%、ランキング3を30%の確率で提示する。
    - 固定的な選択: 特定のユーザに対して、常に同じランキングを提示するような方策。

### ランキング問題の特殊性
1つのアイテムの報酬を評価・予測するのではなく、全体での順位に応じて報酬を評価・予測する必要があるため、通常のオフポリシーよりも複雑な問題を取り扱う必要がある。
- 複数のアイテムの中から一つを選ぶのではなく、アイテム全体の順序を決定する。これは、単一の選択肢を選ぶよりも複雑。
- 各アイテムのポジション（1位、2位など）ごとに、それぞれ異なる報酬が得られる。つまり、報酬はランキング全体の構造に依存して変化する。

### ランキング方策の性能の定義

```math
V(π) := E_{p(x|\pi)\pi(a|x)p(r|x,a)}\Big[\sum_{k=1}^K α_k r_k(x,a)]\Big] = E_{p(x|\pi) \pi(a|x)}[\sum_{k=1}^K α_k q_k(x,a)]
```

$q_k(x,a) = E[r(k)|x,a]$ は、特徴量 x とランキング π が与えられたときに、k番目のポジションで発生する報酬 r(k) の期待値であり、ポジションレベルの**期待報酬関数 (position-level expected reward function)** と呼ぶ。
$α_k (≥ 0)$ は、分析者によって事前に設定されるようなk番目のポジションの重要度。

## IPSの問題点
### IPSの定義
あるデータ収集方策 π₀ により収集されたログデータ D を用いるとき、ランキング方策 π の性能 V(π) に対する IPS 推定量は、次のように表される。

```math
V̂_{IPS}(π; D) = \frac{1}{n} \sum_{i=1}^n \frac{π(a_i | x_i)}{ π₀(a_i | x_i)} \sum_{k=1}^K α_k r_i(k)\\
= \frac{1}{n}  \sum_{i=1}^n w(x_i, a_i)  \sum_{k=1}^K α_k  r_i(k)
```

ここで、

$w(x_i, a_i) = π(a_i | x_i) / π₀(a_i | x_i)$ は、評価方策 π とデータ収集方策 π₀ による行動選択確率の比であり、ランキングレベルの重要度重み (ranking-level importance weight) と呼ばれる。
$V̂_{IPS}^k(π; D) = (1/n)  \sum_{i=1}^n w(x_i, a_i) r_i(k)$ により、k番目のポジションにおける期待報酬に対する IPS 推定量を表すことができる。
$V̂_{IPS}(π; D) = \sum_{k=1}^K α_k V̂_{IPS}^k(π; D)$